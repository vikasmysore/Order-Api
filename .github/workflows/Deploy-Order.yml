name: Build and Deploy Order API to Azure App Service

on:
  push:
    branches:
      - main
      - 'feature/*' 

jobs:
  build:
    runs-on: ubuntu-latest

    services:
      cosmosdb:
        image: mcr.microsoft.com/cosmosdb/linux/azure-cosmos-emulator:vnext-preview
        ports:
          - 8081:8081
        env:
          PROTOCOL: https

    env:
      COSMOSDB_CONNECTION_STRING: "AccountEndpoint=https://localhost:8081/;AccountKey=C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw=="
      COSMOSDB_DATABASE_NAME: "OrderTestDb"
      COSMOSDB_CONTAINER_NAME: "Orders"

    steps:
      # Step 1: Checkout the code
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up .NET SDK
      - name: Set up .NET SDK
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'
      
      - name: Export Cosmos DB Emulator Certificate
        run: |
          sudo apt update && sudo apt install -y openssl
          openssl s_client -connect localhost:8081 </dev/null | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' > cosmos_emulator.cert
          
          sudo cp cosmos_emulator.cert /usr/local/share/ca-certificates/
          sudo update-ca-certificates
      
      # Step 4: Restore dependencies
      - name: Restore dependencies
        run: dotnet restore

      # Step 6: Build the application
      - name: Build application
        run: dotnet build --configuration Release

      - name: Run tests
        run: dotnet test --no-build --verbosity normal

      # Step 7: Publish the application (Create the artifact)
      - name: Publish application
        run: dotnet publish --configuration Release --output ./output

      - name: List contents of output directory
        run: ls -la ./output/

      # Step 8: Upload the artifact to GitHub Packages
      - name: Upload artifact to GitHub Packages
        uses: actions/upload-artifact@v4
        with:
          name: order-api-artifact
          path: ./output
  # test:
  #   runs-on: ubuntu-latest
  #   needs: build

  #   services:
  #     cosmosdb:
  #       image: mcr.microsoft.com/cosmosdb/linux/azure-cosmos-emulator:vnext-preview
  #       ports:
  #         - 8081:8081
  #       env:
  #         PROTOCOL: https

  #   env:
  #     COSMOSDB_CONNECTION_STRING: "AccountEndpoint=https://localhost:8081/;AccountKey=C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw=="
  #     COSMOSDB_DATABASE_NAME: "OrderTestDb"
  #     COSMOSDB_CONTAINER_NAME: "Orders"

  #   steps:
  #     - name: Export Cosmos DB Emulator Certificate
  #       run: |
  #         sudo apt update && sudo apt install -y openssl
  #         openssl s_client -connect localhost:8081 </dev/null | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' > cosmos_emulator.cert
          
  #         sudo cp cosmos_emulator.cert /usr/local/share/ca-certificates/
  #         sudo update-ca-certificates

      # - name: List directory contents
      #   run: |
      #     echo "Listing directory contents:"
      #     ls -la ./output/

      # - name: Run tests
      #   run: cd Tests && dotnet test --no-build --verbosity normal

  # test:
  #   runs-on: windows-latest  # Windows runner for native emulator
  #   needs: build

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Set up .NET SDK
  #       uses: actions/setup-dotnet@v3
  #       with:
  #         dotnet-version: '8.0.x'

  #     - name: Start Cosmos Emulator
  #       shell: pwsh
  #       run: |
  #         # Stop any existing emulator instances
  #         Get-Process -Name 'Microsoft.Azure.Cosmos.Emulator*' -ErrorAction SilentlyContinue | Stop-Process -Force

  #         $emulatorPath = "${env:ProgramFiles}\Azure Cosmos DB Emulator\Microsoft.Azure.Cosmos.Emulator.exe"

  #         # Start emulator with minimal settings
  #         Start-Process $emulatorPath -ArgumentList @(
  #             "/NoUI",
  #             "/NoExplorer",
  #             "/NoFirewall",
  #             "/AllowNetworkAccess",
  #             "/Key=C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw==",
  #             "/PartitionCount=1"
  #         ) -RedirectStandardOutput emulator.log -RedirectStandardError emulator-error.log

  #         # Wait for emulator to become available
  #         $retryCount = 0
  #         $maxRetries = 30
  #         $success = $false

  #         while ($retryCount -lt $maxRetries -and -not $success) {
  #             try {
  #                 $response = Invoke-WebRequest -Uri "https://127.0.0.1:8081/_explorer/emulator.pem" `
  #                     -SkipCertificateCheck `
  #                     -DisableKeepAlive `
  #                     -UseBasicParsing `
  #                     -TimeoutSec 10

  #                 if ($response.StatusCode -eq 200) {
  #                     Write-Host "Emulator ready at attempt $retryCount"
  #                     $success = $true
  #                 }
  #             } catch {
  #                 Write-Host "Waiting for emulator... (Attempt $retryCount/$maxRetries)"
  #                 $retryCount++
  #                 Start-Sleep -Seconds 10
  #             }
  #         }

  #         if (-not $success) {
  #             Get-Content emulator.log
  #             Get-Content emulator-error.log
  #             throw "Emulator failed to start after $maxRetries attempts"
  #         }

      # - name: Trust Emulator Certificate
      #   shell: pwsh
      #   run: |
      #     # Allow insecure SSL for initial connection
      #     [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType]::Tls12
      #     $progressPreference = 'silentlyContinue'
        
      #     try {
      #       # Download certificate with retries
      #       $retryCount = 0
      #       $maxRetries = 5
      #       do {
      #           try {
      #               $certContent = (Invoke-WebRequest -Uri 'https://localhost:8081/_explorer/emulator.pem' -DisableKeepAlive -UseBasicParsing).Content
      #               break
      #           } catch {
      #               $retryCount++
      #               if ($retryCount -ge $maxRetries) { throw }
      #               Start-Sleep -Seconds 10
      #           }
      #       } while ($true)

      #       # Create certificate object
      #       $cert = [System.Security.Cryptography.X509Certificates.X509Certificate2]::new(
      #           [System.Text.Encoding]::UTF8.GetBytes($certContent)
      #       )
      #       # Add to certificate store
      #       $store = New-Object System.Security.Cryptography.X509Certificates.X509Store(
      #           [System.Security.Cryptography.X509Certificates.StoreName]::Root,
      #           'CurrentUser'
      #       )
      #       $store.Open('ReadWrite')
      #       $store.Add($cert)
      #       $store.Close()
            
      #       # Verify installation
      #       $installed = Get-ChildItem Cert:\CurrentUser\Root | 
      #                   Where-Object { $_.Thumbprint -eq $cert.Thumbprint }
      #       if (-not $installed) {
      #           throw "Certificate not installed successfully"
      #       }
      #     } catch {
      #       Write-Error "Certificate trust failed: $_"
      #       exit 1
      #     }

      # - name: Run Integration Tests
      #   run: dotnet test --configuration Release --verbosity normal
      #   env:
      #     CosmosDb__Endpoint: https://localhost:8081
      #     CosmosDb__Key: C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw==

      # - name: Stop Cosmos Emulator
      #   if: always()
      #   shell: pwsh
      #   run: |
      #     Get-Process -Name 'Microsoft.Azure.Cosmos.Emulator*' | Stop-Process -Force

  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    needs: build
    if: github.ref == 'refs/heads/main'

    steps:
      # Step 9: Download the artifact from GitHub Packages
      - name: Download artifact from GitHub Packages
        uses: actions/download-artifact@v4
        with:
          name: order-api-artifact
          path: ./output/
      
      - name: List contents of output directory after download
        run: ls -la ./output

      # Step 10: Azure Login
      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.ARM_CLIENT_ID }}
          tenant-id: ${{ secrets.ARM_TENANT_ID }}
          subscription-id: ${{ secrets.ARM_SUBSCRIPTION_ID }}
          client-secret: ${{ secrets.ARM_CLIENT_SECRET }}

      # Step 11: Fetch connection string for Service Bus from Key Vault
      - name: Fetch Service Bus connection string from Key Vault
        id: fetch_service_bus
        run: |
          SERVICE_BUS_CONNECTION_STRING=$(az keyvault secret show --name ServiceBusConnectionString --vault-name kvvikasdemoorderapi --query value -o tsv)
          echo "SERVICE_BUS_CONNECTION_STRING=$SERVICE_BUS_CONNECTION_STRING" >> $GITHUB_ENV
          if [ -z "$SERVICE_BUS_CONNECTION_STRING" ]; then
          echo "Service Bus connection string is empty. Please check your Key Vault configuration." >&2
          exit 1
          fi
        
      # Step 12: Fetch connection string for Service Bus from Key Vault
      - name: Fetch Cosmos DB connection string from Key Vault
        id: fetch_cosmos_db
        run: |
          COSMOS_DB_CONNECTION_STRING=$(az keyvault secret show --name CosmosDBConnectionString --vault-name kvvikasdemoorderapi --query value -o tsv)
          echo "COSMOS_DB_CONNECTION_STRING=$COSMOS_DB_CONNECTION_STRING" >> $GITHUB_ENV
          if [ -z "$COSMOS_DB_CONNECTION_STRING" ]; then
          echo "Cosmos DB connection string is empty. Please check your Key Vault configuration." >&2
          exit 1
          fi

      # Step 13: Replace the connection strings in appsettings.json
      - name: Manually replace connection strings in appsettings.json
        run: |
          temp_file=$(mktemp)
          jq '.ServiceBusConfiguration.ConnectionString = env.SERVICE_BUS_CONNECTION_STRING | 
            .CosmosDbConfiguration.ConnectionString = env.COSMOS_DB_CONNECTION_STRING' ./output/appsettings.json > "$temp_file" \
          && mv "$temp_file" ./output/appsettings.json

      # Step 14: Deploy to Azure App Service
      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v2
        with:
          app-name: apsvcvikasdemoorderapi
          publish-profile: ${{ secrets.ARM_PUBLISH_PROFILE }}
          package: ./output
